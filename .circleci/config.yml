version: 2.1

jobs:
  build_and_test:
    docker:
      - image: ubuntu:latest
    steps:
      - checkout
      - run:
          name: Prepare Build
          command: ./.circleci/prepare_build.sh
      - run:
          name: chmod install script
          command: chmod +x install_dependencies.sh
      - run:
          name: run install script
          command: ./install_dependencies.sh
      - run:
          name: Add Swap Space
          command: |
            sudo fallocate -l 2G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
      - run:
          name: Build Project
          command: |
            mkdir build
            cd build
            cmake -DROCK_TEST_ENABLED=ON ..
            make -j2 
      - run:
          name: Run C++ Tests
          command: |
            cd build
            make cpp_test
      - run:
          name: Run Python Tests
          command: |
            cd build
            make py_test

workflows:
  build_and_test_workflow:
    jobs:
      - build_and_test
